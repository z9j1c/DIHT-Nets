## Switch'и

#### Общая информация

Свичи обычно работают на L2 и предназначены для связывания устройств внутри одной сети. Роутеры связывают подсети, а свичи узлы внутри подсетей. У свичей больше логики реализовано на уровне железа, у роутеров - на уровне софта.

Прародитель свича - хаб. Хаб распределеяет все входящие пакеты на все исходящие порты кроме того, на который пришёл пакет, свич же перенаправляет пакет только на тот mac-адрес, которму он предназначается.

#### Три уровня разбора пакета 

+ Cut-Through: разбор преамбулы пакета и целевого mac-адреса
+ Fragment-Free: дополнительно разбор mac-адреса отправителя, типа пакета следующего уровня и его заголово. Это позволяет избежать фрагментации пакетов
+ Store and Forward: каждый пакет полностью разбирается, проверяется check-sum.

#### Архитектуры свичей

Shared bus switching: последовательный обход всех портов в поисках вновь пришедшего пакета. Оптимизация, ставшая де-факто стандартом: пакет сразу отправляется на все порты, и лишь потом арбитр
определяет, с каких портов пакет действительно должен быть отправлен.

Crossbar switching: linebar - 4/8/... портов, объединённых в одну карту. Имеется несколько арбитров, процесс разбора пакетов относительно портов распараллливается.

###№ Буффризация

На ранних свичах был один большой буффер. Сейчас на каждом порту есть буфер, в котором накапливаются пакеты.

#### Oversubscription

Пусть есть свич с 48 гигибитными портами, каждый из портов заявляет, что он работает в гигабитном режиме. Половина портов на приём, половина на отдачу. Oversubscription случается, когда через свич прогоняется
больше 24 гигабит/с. Поэтому при использовании свича нужно помнить про производительность fabric ("мозги свича", его внутрення топология).

#### Head-of-Line blocking

Ситуация, когда на порт приходится больше 100% его bandwidth. Будет потеря пакетов. Egress buffer - буфер исходящего трафика, используется при пиковой (кратковременной) повышенной нагрузке сеть, когда пакеты нужно придержать для избегания потерь.

#### OSI Switching

+ L2 ...
+ L3 ...
+ L4 - умеют по-разному работать с трафиком разных приложений: deep packet inspection, firewalls

## Spanning Tree Protocol
Протокол позволяет избежать петель в топологии сети.

#### Стандарты
+ Original STP
+ PVST+: сделали CISCO, добавилась поддержка VLAN
+ RSTP / 802.1w: быстрая сходимость (доведение информации об изменении сети до всех её узлов)
+ Rapid PVST+: быстрая сходимость, подходит для больших сетей, VLAN'ы

#### Мир без STP и его проблемы

Broadcast Storm: идёт broadcast или switch не знает, где расположен узел с целевым mac-адресом пакета. Происходит отправка пакета на все порты.
К тому же таблица соответствия mac-адресов портам постоянно обновляется при закольцевании.

Duplicated Frames: дублирование пакетов при не-дублицирующих протоколах в сети.

#### Мир с STP

STP строит что-то вроде минимального остовного дерева. Из всех соединений строится граф, по которому ходят пакеты.

#### Обзор протокола с высокоуровневой точки зрения

1. Выбирается Root Bridge. У него все порты переходят в состояние `forward`: они могу принимать и перенаправлять трафик (и так останется во веки веков)
2. Каждый не-root bridge свич авбирает порт с оптимальным путём до root bridge'а
3. В каждой связке выбирается designated порт

Три основные *роли* портов:
+ Root port: лучшие паршрут до root bridge
+ Designated port: можно получать трафик и перенаправлять на RP, отправлять свой нельзя
+ Non-designated port: все остальные порты блокируются

*Состояния* портов (нужны для перехода между ролями, изменения и запоминания топологии сети):
+ Disabled: интерфейс выключен
+ Blocking: блокирует трафик, может перейти в Listening
+ Listening: переходное состояние (порт был Blocking, но топология поменялась и он начал принимать трафик, но ещё не учит mac-адреса), через 15 секунд переходит в Learning
+ Learning: порт начинает учить mac-адреса и запоминать, кто где находится. Потом может перейти в Forwardning
+ Forwarding: состояние designated роли, свободно оперирует с трафиком, может быть переведён в состояние Blocking

Выбор Root Bridge:
1. Свичи назаначают себе `BridgeID`: к `3278` прибавляется текущий `VLAN` и конкатенируется с mac-адресом свича, пример: `32769aaaa:aaaa:aaaa`
2. Каждые 2 секунды свичи обмениваются BID
3. Выбирается минимальный BID, его порты переходят в состояние Forwarding
4. Выбор портов для оптимального взаимодействия с Root Bridge среде не-root'ов: обмен информацией о стоимости пути, выбор минимального
5. Выбор designated-порта между не-root'ами
    * Наименьшая стоимость у свича
    * Иначе, наименьший BID
    * Иначе, наименьший приоритет порта
    * Иначе, наименьший соседний номер порта

#### Таймеры и сообщения
* Hello отправляется каждые 2 секунды
* MaxAge: в 10 раз дольше `hello`-интервала, после отсутсвия `hello` в течениеи `MaxAge` STP начинает перестроение сети
* Forward Delay: 15 секунд - время на обучение.